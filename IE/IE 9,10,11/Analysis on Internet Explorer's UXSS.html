<!DOCTYPE html>
<!-- saved from url=(0031)http://blog.innerht.ml/ie-uxss/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Analysis on Internet Explorer's UXSS</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" type="text/css" href="./Analysis on Internet Explorer&#39;s UXSS_files/railscasts.css">
    <script type="text/javascript" src="./Analysis on Internet Explorer&#39;s UXSS_files/highlight.pack.js"></script>

    <link rel="stylesheet" type="text/css" href="./Analysis on Internet Explorer&#39;s UXSS_files/screen.css">
    <link href="./Analysis on Internet Explorer&#39;s UXSS_files/css" rel="stylesheet" type="text/css">
    
    <link rel="canonical" href="http://blog.innerht.ml/ie-uxss/">
    
    <meta property="og:site_name" content="XSS Jigsaw">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Analysis on Internet Explorer&#39;s UXSS">
    <meta property="og:description" content="Status: Fixed (as of Jan 13, 2016) Recently a Universal Cross-Site Scripting(UXSS) vulnerability (CVE-2015-0072) was disclosed on the Full Disclosure mailing list. This unpatched 0day vulnerability discovered by David Leo results in a full bypass of the Same-Origin Policy(...">
    <meta property="og:url" content="http://blog.innerht.ml/ie-uxss/">
    <meta property="article:published_time" content="2015-02-04T10:00:00.000Z">
    <meta property="article:modified_time" content="2016-01-14T04:00:33.000Z">
    <meta property="article:tag" content="Internet Explorer">
    <meta property="article:tag" content="Analysis">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Analysis on Internet Explorer&#39;s UXSS">
    <meta name="twitter:description" content="Status: Fixed (as of Jan 13, 2016) Recently a Universal Cross-Site Scripting(UXSS) vulnerability (CVE-2015-0072) was disclosed on the Full Disclosure mailing list. This unpatched 0day vulnerability discovered by David Leo results in a full bypass of the Same-Origin Policy(...">
    <meta name="twitter:url" content="http://blog.innerht.ml/ie-uxss/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "XSS Jigsaw",
    "author": {
        "@type": "Person",
        "name": "File Descriptor",
        "url": "http://blog.innerht.ml/author/file",
        "sameAs": null
    },
    "headline": "Analysis on Internet Explorer&#x27;s UXSS",
    "url": "http://blog.innerht.ml/ie-uxss/",
    "datePublished": "2015-02-04T10:00:00.000Z",
    "dateModified": "2016-01-14T04:00:33.000Z",
    "keywords": "Internet Explorer, Analysis",
    "description": "Status: Fixed (as of Jan 13, 2016) Recently a Universal Cross-Site Scripting(UXSS) vulnerability (CVE-2015-0072) was disclosed on the Full Disclosure mailing list. This unpatched 0day vulnerability discovered by David Leo results in a full bypass of the Same-Origin Policy(..."
}
    </script>

    <meta name="generator" content="Ghost 0.5">
    <link rel="alternate" type="application/rss+xml" title="XSS Jigsaw" href="http://blog.innerht.ml/rss/">
</head>
<body class="post-template tag-internet-explorer tag-analysis">
  <div id="content">
    <div id="content-left">
      <div class="vertical">
        <div class="blog-title-wrap">
        
        <h1 class="blog-title"><a href="http://blog.innerht.ml/">XSS Jigsaw</a></h1>
        </div>

        <div class="blog-description-wrap">
        <h2 class="blog-description">Hello, I want to play a game. //@filedescriptor</h2>
        </div>
    </div>
    </div>

    

<div id="content-main">

  <article class="post tag-internet-explorer tag-analysis">


    <h2 class="post-title"><a href="http://blog.innerht.ml/ie-uxss/">Analysis on Internet Explorer's UXSS</a></h2>
    <span class="post-meta"><time datetime="2015-02-04">February 4, 2015</time>  | Tags: <a href="http://blog.innerht.ml/tag/internet-explorer/">Internet Explorer</a>, <a href="http://blog.innerht.ml/tag/analysis/">Analysis</a></span>

    <section class="post-content">
      <p style="text-align: center;">Status: <span style="color: green">Fixed</span><sub> (as of Jan 13, 2016)</sub></p>

<p>Recently <a href="http://seclists.org/fulldisclosure/2015/Feb/0">a Universal Cross-Site Scripting(UXSS) vulnerability</a> (CVE-2015-0072) was disclosed on the Full Disclosure mailing list. This unpatched 0day vulnerability discovered by David Leo results in a full bypass of the Same-Origin Policy(SOP) on the latest version of Internet Explorer. This article will briefly explain the technical details behind the vulnerability.</p>

<h1 id="theattack">The Attack</h1>

<p>The original Proof-of-Concept(PoC) can be boiled down into the following simplified one:</p>

<pre><code class="language-html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">iframe</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"redirect.php"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">iframe</span>&gt;</span>  
<span class="hljs-tag">&lt;<span class="hljs-title">iframe</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"https://www.google.com/images/srpr/logo11w.png"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">iframe</span>&gt;</span>  
<span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">  
    top[<span class="hljs-number">0</span>].eval(<span class="hljs-string">'_=top[1];alert();_.location="javascript:alert(document.domain)"'</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>  
</code></pre>

<p>The simplified PoC requires an iframe with a HTTP redirect to a resource on the target domain, and another iframe which also loads a resource on the target domain. What is worth noting is that the two resources do not necessarily need to be the same, nor their Content-Type matter. In summary:</p>

<ol>
<li>Browser renders the first frame and issues a request to redirect.php.  </li>
<li>Browser renders the second frame and issues a request to target resource.  </li>
<li>Browser executes the script which invokes eval on the WindowProxy object of the first frame and perform the following steps: <br>
<ol><li>Assign the WindowProxy object of the second frame to a variable.</li>
<li>Pop-up an alert dialog box.</li>
<li>Wait until the dialog box is closed by the user.</li>
<li>Change the location via the variable assigned of the second frame and inject payloads.</li></ol></li>
<li>The injected payload is executed in the second frame on the target's origin.</li>
</ol>

<blockquote>
  <p>Updated: The resource requested by the first frame does not need to be on the target domain.</p>
</blockquote>

<h1 id="underthehood">Under The Hood</h1>

<p>Apparently, the key of the vulnerability appears to be the dialog box. Before diving into it, it is necessary to know that modal dialogs like alert, prompt, and confirm (or other synchronized functions) will freeze browsers' process due to JavaScript's single-threaded nature. However, the concrete implementation slightly differs on different browsers. Let's take a look on the timelines of each browser handling the PoC:</p>

<h2 id="firefox">Firefox</h2>

<p><img src="./Analysis on Internet Explorer&#39;s UXSS_files/firefox.png" alt="Timeline for Firefox"></p>

<p>When the dialog box pops up, Firefox will continue to handle network requests. After the target resource on frame 1 was redirected and finished loading, the original script execution will be terminated and the dialog box will be closed automatically at the same time (<code>NS_ERROR_NOT_AVAILABLE: prompt aborted by user</code>). Therefore, anything after the dialog box will never be executed.</p>

<h2 id="chrome">Chrome</h2>

<p><img src="./Analysis on Internet Explorer&#39;s UXSS_files/chrome.png" alt="Timeline for Chrome"></p>

<p>When the dialog box pops up, all network traffic in Chrome will be clogged up until the dialog box is manually closed. After that, even the location change can be executed, there won't be any danger since the origin of frame 1 remains the same (attacker's) instead of target's origin.</p>

<h2 id="internetexplorer">Internet Explorer</h2>

<p><img src="./Analysis on Internet Explorer&#39;s UXSS_files/ie.png" alt="Timeline for Internet Explorer"></p>

<p>When the dialog box pops up, Internet Explorer will also continue to handle network requests. However, when the dialog box is manually closed after the target resource finished loading, the location change will be executed on behalf of the target resource (i.e. target's origin).</p>

<h2 id="therootcause">The Root Cause</h2>

<p>Before redirecting to target resource, script execution does not break SOP because redirect.php is still on the same origin of the attacker's. However, once the target resource finished loading on frame 1, Internet Explorer will update the origin information accordingly. As a result, the previous script execution will suddenly be executed on the targets' origin.</p>

<p>As a side note, the attack has to be done using two frames because Internet Explorer will remove all the object references once navigation occurs. The suggested fix would be either terminate the script execution or remain the origin information when navigation occurs.</p>

<blockquote>
  <p>Updated: It turns out it is not completely a Time-of-check Time-of-use(TOCTOU) issue. In fact, the origin check is discarded after the thread blocking finished.</p>
</blockquote>

<h1 id="userinteraction">User Interaction</h1>

<p>It seems that the attack requires user interaction (dialog box) which makes it less plausible, while it actually <em>does</em> not. Consider the following improved PoC:</p>

<pre><code class="language-html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">iframe</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"redirect.php"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">iframe</span>&gt;</span>  
<span class="hljs-tag">&lt;<span class="hljs-title">iframe</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"https://www.google.com/images/srpr/logo11w.png"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">iframe</span>&gt;</span>  
<span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">  
    top[<span class="hljs-number">0</span>].eval(<span class="hljs-string">'_=top[1];with(new XMLHttpRequest)open("get","sleep.php",false),send();_.location="javascript:alert(document.domain)"'</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>  
</code></pre>

<p>In essence, abusing dialog boxes is just one way to achieve thread blocking. We can issue a synchronous request with an artificial delay using XMLHttpRequest</p>

<h1 id="affectedversions">Affected Versions</h1>

<p>It is confirmed that the vulnerability affects Internet Explorer 10 and 11 on Windows 7 and Windows 8.1. <br>
Windows 10 is not affected (Edge/IE).</p>

<h1 id="remedy">Remedy</h1>

<ul>
<li><p>For site owners, there is no feasible way to prevent this attack. Some suggest relying on X-Frame-Options(XFO), but it is not helping much unless you are confident that <em>all</em> responses have XFO applied.</p></li>
<li><p>For normal users, consider switching to other browsers until Microsoft patches the vulnerability.</p></li>
</ul>

<h1 id="references">References</h1>

<ul>
<li><a href="http://innerht.ml/pocs/ie-uxss/poc.php">Simplified PoC</a></li>
<li><a href="http://innerht.ml/pocs/ie-uxss/poc_withoutui.php">PoC without user interaction</a></li>
</ul>
    </section>

    <footer class="post-footer">

      <section class="share">
        <h4>Share this post</h4>
        <a class="icon-twitter" href="http://twitter.com/share?text=Analysis%20on%20Internet%20Explorer%27s%20UXSS&amp;url=http://blog.innerht.ml/ie-uxss/" onclick="window.open(this.href, &#39;twitter-share&#39;, &#39;width=550,height=235&#39;);return false;">
            <span class="hidden">Twitter</span>
        </a>
        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.innerht.ml/ie-uxss/" onclick="window.open(this.href, &#39;facebook-share&#39;,&#39;width=580,height=296&#39;);return false;">
            <span class="hidden">Facebook</span>
        </a>
        <a class="icon-google-plus" href="https://plus.google.com/share?url=http://blog.innerht.ml/ie-uxss/" onclick="window.open(this.href, &#39;google-plus-share&#39;, &#39;width=490,height=530&#39;);return false;">
            <span class="hidden">Google+</span>
        </a>
      </section>

    </footer>


  </article>

</div>

    <footer class="site-footer">
        <a class="subscribe icon-feed" href="http://blog.innerht.ml/rss/"><span class="tooltip">Subscribe!</span></a>
        <div class="">
             <section class="copyright">All content copyright <a href="http://blog.innerht.ml/">XSS Jigsaw</a> © 2015 • All rights reserved.</section>
             <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://ghost.org/">&nbsp;</a>
               <a href="http://ghost.org/">Ghost</a> | 
               <a href="https://github.com/dongri/Coder">Coder</a> theme forked from Casper by 
               <a href="http://twitter.com/@dongriat">@dongriat</a></section>
        </div>
    </footer>

    <script src="./Analysis on Internet Explorer&#39;s UXSS_files/jquery.min.js"></script>

    <script type="text/javascript" src="./Analysis on Internet Explorer&#39;s UXSS_files/index.js"></script>

  </div>


</body></html>