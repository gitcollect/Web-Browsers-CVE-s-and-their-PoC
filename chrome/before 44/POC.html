<!DOCTYPE html>
<!-- saved from url=(0070)http://blog.innerht.ml/cross-origin-css-attacks-revisited-feat-utf-16/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Cross-Origin CSS Attacks Revisited (feat. UTF-16)</title>
    <meta name="description" content="">

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" type="text/css" href="./POC_files/railscasts.css">
    <script type="text/javascript" src="./POC_files/highlight.pack.js"></script>

    <link rel="stylesheet" type="text/css" href="./POC_files/screen.css">
    <link href="./POC_files/css" rel="stylesheet" type="text/css">
    
    <link rel="canonical" href="http://blog.innerht.ml/cross-origin-css-attacks-revisited-feat-utf-16/">
    
    <meta property="og:site_name" content="XSS Jigsaw">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Cross-Origin CSS Attacks Revisited (feat. UTF-16)">
    <meta property="og:description" content="This blog post is a write-up of CVE-2015-1287 and CVE-2015-5826 Prologue If you are a boring person like me and read specs in spare time, you may have come across this potential attack described by the CSP 2 spec:     [..]   if...">
    <meta property="og:url" content="http://blog.innerht.ml/cross-origin-css-attacks-revisited-feat-utf-16/">
    <meta property="article:published_time" content="2016-02-10T07:18:00.000Z">
    <meta property="article:modified_time" content="2016-04-27T10:58:08.000Z">
    <meta property="article:tag" content="Bug Bounty">
    <meta property="article:tag" content="CSS">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Cross-Origin CSS Attacks Revisited (feat. UTF-16)">
    <meta name="twitter:description" content="This blog post is a write-up of CVE-2015-1287 and CVE-2015-5826 Prologue If you are a boring person like me and read specs in spare time, you may have come across this potential attack described by the CSP 2 spec:     [..]   if...">
    <meta name="twitter:url" content="http://blog.innerht.ml/cross-origin-css-attacks-revisited-feat-utf-16/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "XSS Jigsaw",
    "author": {
        "@type": "Person",
        "name": "File Descriptor",
        "url": "http://blog.innerht.ml/author/file",
        "sameAs": null
    },
    "headline": "Cross-Origin CSS Attacks Revisited (feat. UTF-16)",
    "url": "http://blog.innerht.ml/cross-origin-css-attacks-revisited-feat-utf-16/",
    "datePublished": "2016-02-10T07:18:00.000Z",
    "dateModified": "2016-04-27T10:58:08.000Z",
    "keywords": "Bug Bounty, CSS",
    "description": "This blog post is a write-up of CVE-2015-1287 and CVE-2015-5826 Prologue If you are a boring person like me and read specs in spare time, you may have come across this potential attack described by the CSP 2 spec:     [..]   if..."
}
    </script>

    <meta name="generator" content="Ghost 0.5">
    <link rel="alternate" type="application/rss+xml" title="XSS Jigsaw" href="http://blog.innerht.ml/rss/">
</head>
<body class="post-template tag-bug-bounty tag-css">
  <div id="content">
    <div id="content-left">
      <div class="vertical">
        <div class="blog-title-wrap">
        
        <h1 class="blog-title"><a href="http://blog.innerht.ml/">XSS Jigsaw</a></h1>
        </div>

        <div class="blog-description-wrap">
        <h2 class="blog-description">Hello, I want to play a game. //@filedescriptor</h2>
        </div>
    </div>
    </div>

    

<div id="content-main">

  <article class="post tag-bug-bounty tag-css">


    <h2 class="post-title"><a href="http://blog.innerht.ml/cross-origin-css-attacks-revisited-feat-utf-16/">Cross-Origin CSS Attacks Revisited (feat. UTF-16)</a></h2>
    <span class="post-meta"><time datetime="2016-02-10">February 10, 2016</time>  | Tags: <a href="http://blog.innerht.ml/tag/bug-bounty/">Bug Bounty</a>, <a href="http://blog.innerht.ml/tag/css/">CSS</a></span>

    <section class="post-content">
      <blockquote>
  <p>This blog post is a write-up of CVE-2015-1287 and CVE-2015-5826</p>
</blockquote>

<h1 id="prologue">Prologue</h1>

<p>If you are a boring person like me and read specs in spare time, you may have come across this potential attack described by the <a href="https://www.w3.org/TR/CSP2/#security-css-parsing">CSP 2 spec</a>:  </p>

<blockquote>
  <p>[..]
  if the user agent uses a lax CSS parsing algorithm, an attacker might be able to trick the user agent into accepting malicious "stylesheets" hosted by an otherwise trustworthy origin.</p>
</blockquote>

<h2 id="laxparsing">Lax Parsing</h2>

<p>Unlike JavaScript which stops parsing when a syntax error is encountered, CSS parsing rules allow to <a href="https://www.w3.org/TR/CSS2/syndata.html#parsing-errors">ignore certain illegal parts</a> in quirks mode.</p>

<h2 id="howthiswasabused">How This Was Abused</h2>

<p>Back in 2009, Chris Evans <a href="http://scarybeastsecurity.blogspot.hk/2009/12/generic-cross-browser-cross-domain.html">discovered</a> that such behavior can lead to cross-domain theft. The way it worked is to find a page which reflects GET paremeters, inject crafted payload and import it in an attacker controlled page. Since a picture is worth a thousand words, here is a picture which depicts the attack:</p>

<p><img src="./POC_files/css-cross-domain-theft-3.png" alt="How the attack is conducted"></p>

<p>In short, attackers inject two strings, pre-string (<code>{}#f{font-family:'</code>) and post-string (<code>';}</code>) that surround the secret data. The junk is ignored while the payload then turns the secret data into a CSS property (font-family in this case), and can be revealed in computed style. Note that the injected strings do not contain harmful characters (angle brackets) so they will generally not be escaped.</p>

<p>Ultimately this attack can lead to data exfiltration. Since cookie is sent along the request, the stolen data can contain a CSRF token or personal information.</p>

<p>There are however certain restrictions of this attack:</p>

<ul>
<li>The extracted data needs to sit in between the pre-string and post-string. Also having 2 injection points is not uncommon yet not very usual</li>
<li>The extracted data cannot contain both single and double quotes at the same time (because the data needs to be treated as a CSS string)</li>
<li>The extracted data cannot contain line breaks (CSS string does not support multiple lines)</li>
</ul>

<p>These conditions are not easy to meet, especially the "no line breaks" requirement as they are inevitable in modern coding style.</p>

<h2 id="howitended">How It ended</h2>

<p>Internet Explorer and Firefox disabled the ability to import CSS with incorrect MIME type (text/css) cross-origin. Webkit-based browsers on the other hand, used strict parsing (stop parsing when error encountered) for cross-origin CSS for the sake of compatibility. The approach Webkit adopted is also suggested by CSP 2:</p>

<blockquote>
  <p>[..] User agents SHOULD defend against both attacks using the same mechanism: stricter CSS parsing rules for style sheets with improper MIME types.</p>
</blockquote>

<h1 id="thinkingoutofthebox">Thinking Out Of The Box</h1>

<p>The suggested defense looks like a perfect balance: It resolves the issue while not breaking old websites which use incorrect MIME type for CSS. Well, it surely does not break those websites, but it is not unbreakable either. It assumes that it is unlikely for attackers to influence a document in a way such that the content is a valid CSS. What I am going to tell you is that we can indeed make a document syntactically valid with a little help from charset.</p>

<h2 id="manipulatingcharest">Manipulating Charest</h2>

<p>The <a href="https://www.w3.org/TR/css3-syntax/#input-byte-stream">CSS spec</a> defines the precedence of what charset should be used for a CSS:</p>

<ol>
<li>BOM  </li>
<li>Content-Type header (e.g. <code>Content-Type: text/html; charset=utf-8</code>)  </li>
<li>Environment encoding (the <em>charset</em> attribute of <code>&lt;link&gt;</code>)</li>
</ol>

<p>If a page does not specific BOM or charset on Content-Type, the encoding decision will fallback to environemnt encoding which we can control. BOM is not really an issue since it is rarely used. Content-Type header is a bit tough because modern frameworks have it set by default, though it is not uncommon to see a page without charset specified on Content-Type due to verious reasons. Facebook is an example which does not have charset set through Content-Type but instead relies on <code>&lt;meta charset&gt;</code>.</p>

<p><img src="./POC_files/facebook-http-response.png" alt="Facebook HTTP Response"></p>

<h2 id="fiddlingcsssyntax">Fiddling CSS Syntax</h2>

<p>Now to the most interesting part: forcing a document to be a valid CSS. Before that, we need to understand the syntax.</p>

<p><img src="./POC_files/stylesheet.png" alt="Stylesheet"></p>

<p>A CSS is a stylesheet. It has to start with <em>@-rules</em> or <em>rulesets</em>. Since It is nearly impossible for a document to start with <code>@</code> or pull it out of thin air, we are only interested in <em>ruleset</em>.</p>

<p><img src="./POC_files/ruleset.png" alt="Ruleset"></p>

<p>A rule is essentially <em>selector</em> + <em>block</em>. <em>Selectors</em> have different types but most of them contain <em>identifier</em>. According to the <a href="https://www.w3.org/TR/CSS2/syndata.html#value-def-identifier">spec</a>, identifiers can contain only the characters [a-zA-Z0-9] and ISO 10646 characters U+00A0 and higher, plus the hyphen (-) and the underscore (_). Apparently, CSS supports wide range (U+00A0 ~ U+10FFFF) of Unicode characters to be valid identifiers, but penalizes ASCII characters as a single bracket or quote which is common in a HTML document is treated invalid.</p>

<h3 id="howutf16comesintoplay">How UTF-16 Comes Into Play</h3>

<p>Unlike most of the charset, UTF-16 always maps 2 or more bytes into 1 character, even for ASCII. </p>

<p><img src="./POC_files/charset-mapping-1.png" alt="Charset Mapping"></p>

<p>Now you start seeing the pattern: we can tell the parser that the document should be decoded as UTF-16, and all in a sudden the whole document becomes a valid identifier! This is because the transformation "eliminates" all ASCII characters, including line breaks and quotes (a <code>NUL</code> byte is needed for padding for an acutal ASCII character in UTF-16). We then add a wildcard selector (*) so that the following rule matches an element.</p>

<p>So we now have the selector settled, the parser continues to receive <em>block</em>.</p>

<p><img src="./POC_files/block-1.png" alt="Block"></p>

<p>At this point we just need to find an injection point and make a <em>block</em> to complete our payload. For <em>declaration</em>, we need a property that accepts arbitrary string value so that we can steal the secret data. <code>font-family</code> is the perfect choice as it supports not only string but also <a href="https://drafts.csswg.org/css-fonts-3/#font-family-prop">identifier</a>. Let's see what we've got so far:</p>

<pre><code class="language-css hljs"><span class="hljs-tag">Identifier</span>(<span class="hljs-tag">junk</span>), * <span class="hljs-rules">{ <span class="hljs-rule"><span class="hljs-attribute">font-family</span>:<span class="hljs-value"> <span class="hljs-function">Identifier</span>(secret data)  
</span></span></span></code></pre>

<p>And that's it! ...Wait, where is the closing brace (<code>}</code>)? Actually we can ignore it and it still remains valid. As per <a href="https://www.w3.org/TR/css3-syntax/#consume-a-simple-block0">spec</a>, when the parser reaches EOF (End-of-File), the <em>block</em> will be closed automatically. Taking advantage of it, we only need <strong>one injection point</strong> to perform the attack.</p>

<h2 id="nosniff">Nosniff?</h2>

<p>You may wonder: isn't <code>X-Content-Type-Options</code> exactly there to prevent such attack? Unfortunately, for some reasons Webkit does not honor this header when importing CSS. In other word, having <code>X-Content-Type-Options: nosniff</code> has no effect when the document is being treated as an external CSS.</p>

<h2 id="limitation">Limitation</h2>

<p>To sum up, the attack works when the following conditions are met:</p>

<ul>
<li>The target does not have charset set in the <code>Content-Type</code> header</li>
<li>The injection point does not sanitize <code>NUL</code> byte</li>
</ul>

<p>Compared with the original attack, the possibility to perform the attack is tremendously increased.</p>

<h1 id="poc">PoC</h1>

<blockquote>
  <p>"PoC || GTFO"  - whoever</p>
</blockquote>

<p>The following PoC will demonstrate how this attack can steal cookies of victim's from <a href="http://php.net/manual/en/function.phpinfo.php">phpinfo</a>. Phpinfo is a common information leakage which contains limited server information and <strong>HTTP request information</strong>. Normally it is immune from XSS, with this attack <br>
we can exfiltrate httpOnly cookies from victim since it meets all the attack requirements (i.e. no charset on header and accepts <em>NUL</em> bytes).</p>

<p>PoC (Chrome 43, Safari 8 or iOS 8): <a href="http://innerht.ml/csstheft/phpinfo.html">http://innerht.ml/csstheft/phpinfo.html</a></p>

<p><img src="./POC_files/poc-phoinfo.png" alt="PoC on phpinfo"></p>

<h1 id="fix">Fix</h1>

<p>Webkit and Blink fixed the issue by refusing to load a cross-origin document with incorrect MIME type as CSS.</p>

<p><img src="./POC_files/patched-message-1.png" alt="Patched message"></p>

<p>Although patched in modern browsers, I reckon there are still some homemade browsers which are vulnerable.</p>

<h1 id="furtherreading">Further Reading</h1>

<ul>
<li>There is also a similar attack for its counterpart JavaScript called <a href="https://www.mbsd.jp/Whitepaper/xssi.pdf">XSSI</a></li>
<li><a href="https://tools.ietf.org/html/draft-west-first-party-cookies-01#section-1.1">First-Party-Only Cookies</a> is a proposed solution which prevents cookies being sent off in a third-party context</li>
<li><a href="https://www.w3.org/TR/epr/">Entry Point Regulation</a> is an alternative which restricts documents being used as external resouces, although IMO the manifest is rather verbose</li>
</ul>

<h1 id="references">References</h1>

<ul>
<li><a href="https://code.google.com/p/chromium/issues/detail?id=419383">Original Report to Chromium</a></li>
<li><a href="http://www.phpied.com/css-railroad-diagrams/">CSS railroad diagrams</a></li>
</ul>
    </section>

    <footer class="post-footer">

      <section class="share">
        <h4>Share this post</h4>
        <a class="icon-twitter" href="http://twitter.com/share?text=Cross-Origin%20CSS%20Attacks%20Revisited%20(feat.%20UTF-16)&amp;url=http://blog.innerht.ml/cross-origin-css-attacks-revisited-feat-utf-16/" onclick="window.open(this.href, &#39;twitter-share&#39;, &#39;width=550,height=235&#39;);return false;">
            <span class="hidden">Twitter</span>
        </a>
        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.innerht.ml/cross-origin-css-attacks-revisited-feat-utf-16/" onclick="window.open(this.href, &#39;facebook-share&#39;,&#39;width=580,height=296&#39;);return false;">
            <span class="hidden">Facebook</span>
        </a>
        <a class="icon-google-plus" href="https://plus.google.com/share?url=http://blog.innerht.ml/cross-origin-css-attacks-revisited-feat-utf-16/" onclick="window.open(this.href, &#39;google-plus-share&#39;, &#39;width=490,height=530&#39;);return false;">
            <span class="hidden">Google+</span>
        </a>
      </section>

    </footer>


  </article>

</div>

    <footer class="site-footer">
        <a class="subscribe icon-feed" href="http://blog.innerht.ml/rss/"><span class="tooltip">Subscribe!</span></a>
        <div class="">
             <section class="copyright">All content copyright <a href="http://blog.innerht.ml/">XSS Jigsaw</a> © 2015 • All rights reserved.</section>
             <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://ghost.org/">&nbsp;</a>
               <a href="http://ghost.org/">Ghost</a> | 
               <a href="https://github.com/dongri/Coder">Coder</a> theme forked from Casper by 
               <a href="http://twitter.com/@dongriat">@dongriat</a></section>
        </div>
    </footer>

    <script src="./POC_files/jquery.min.js"></script>

    <script type="text/javascript" src="./POC_files/index.js"></script>

  </div>


</body></html>